import {
  Text,
  TextContent,
  Title,
  Grid,
  GridItem,
} from '@patternfly/react-core';
import {
  Chart,
  ChartBar,
  ChartPie,
  ChartThemeColor,
} from '@patternfly/react-charts';
import {
  TableComposable,
  Thead,
  Tbody,
  Th,
  Tr,
  Td,
} from '@patternfly/react-table';
import Page from '../../common/page';
import getHeaderDate from '../../common/get-header-date';
import TopCves from '../Components/top-cves';
import TopRules from '../Components/top-rules';
import React from 'react';

export const VulnerabilityExecutiveReportTemplate = ({
  system_count,
  cves_total,
  rules_total,
  recent_cves,
  top_cves,
  top_rules,
  rules_by_severity,
  cves_by_severity,
}: {
  system_count: number;
  cves_total: number;
  rules_total: number;
  recent_cves: {
    last30days: number;
    last7days: number;
    last90days: number;
  };
  top_cves: {
    cvss2_score: string;
    cvss3_score: string;
    description: string;
    known_exploit: boolean;
    rule_presence: boolean;
    security_rule: boolean;
    synopsis: string;
    systems_affected: number;
  }[];
  top_rules: {
    associated_cves: string[];
    description: string;
    name: string;
    rule_id: string;
    severity: number;
    systems_affected: number;
  }[];
  rules_by_severity: {
    [key: string]: {
      rule_count: number;
      systems_affected: number;
    };
  };
  cves_by_severity: {
    [key: string]: {
      count: number;
      known_exploit_count: number;
      percentage: number;
    };
  };
}) => {
  const cvesBySeverity = Object.entries(cves_by_severity);
  const rulesBySeverity = Object.entries(rules_by_severity);
  const rulesBySeverityValues = Object.values(rules_by_severity);
  const maxSystemsAffected = rulesBySeverityValues.reduce(
    (acc, { systems_affected }) =>
      systems_affected > acc ? systems_affected : acc,
    0
  );
  return (
    <React.Fragment>
      <Page>
        <Title
          headingLevel="h2"
        >
          Red Hat Insights
        </Title>
        <Title
          headingLevel="h1"
        >
          Executive report: Vulnerabilities
        </Title>
        <TextContent>
          <Text>
            Report generated&nbsp;{getHeaderDate()}
          </Text>
          <Text>
            This report is an executive summary of vulnerabilities that may
            impact your Red Hat Enterprise Linux servers.
          </Text>
          <Text>
            The vulnerability service is analyzing{' '}
            {system_count.toLocaleString('en')} RHEL systems and has identified{' '}
            {cves_total.toLocaleString('en')} CVEs and{' '}
            {rules_total.toLocaleString('en')} security rules that impact 1 or
            more of these systems.
          </Text>
        </TextContent>
        <Grid>
          <GridItem span={4}>
            <div>
              {system_count}
            </div>
            <div>Analyzed RHEL systems</div>
          </GridItem>
          <GridItem span={4}>
            <div>
              {cves_total}
            </div>
            <div>Identified CVEs</div>
          </GridItem>
          <GridItem span={4}>
            <div>
              {rules_total}
            </div>
            <div>Identified security rules</div>
          </GridItem>
        </Grid>
      </Page>
      {/* END OF PAGE 1 */}
      <Page>
        <Title
          headingLevel="h2"
        >
          CVEs
        </Title>
        <Title
          headingLevel="h3"
        >
          Identified CVEs by CVSS score
        </Title>
        <Grid hasGutter>
          <GridItem span={4}>
            <ChartPie
              constrainToVisibleArea={true}
              data={[
                {
                  x: '8.0 - 10.0',
                  y: cves_by_severity['8to10'].percentage,
                },
                {
                  x: '4.0 - 7.9',
                  y: cves_by_severity['4to7.9'].percentage,
                },
                {
                  x: '0.0 - 3.9',
                  y: cves_by_severity['0to3.9'].percentage,
                },
              ]}
              height={230}
              legendData={[
                {
                  name: `8.0 - 10.0: ${cves_by_severity['8to10'].percentage} %`,
                },
                {
                  name: `4.0 - 7.9: ${cves_by_severity['4to7.9'].percentage} %`,
                },
                {
                  name: `0.0 - 3.9: ${cves_by_severity['0to3.9'].percentage} %`,
                },
              ]}
              legendOrientation="vertical"
              legendPosition="right"
              padding={{
                bottom: 0,
                left: 0,
                right: 140,
                top: 0,
              }}
              themeColor={ChartThemeColor.orange}
              width={350}
            />
          </GridItem>
          <GridItem span={8}>
            <TableComposable variant="compact" borders={false} isStriped>
              <Thead>
                <Tr>
                  <Th modifier="wrap">CVSS score range</Th>
                  <Th modifier="wrap">Number of CVEs</Th>
                  <Th modifier="wrap">Known exploits</Th>
                </Tr>
              </Thead>
              <Tbody>
                {cvesBySeverity
                  .filter(([key]) => key != 'na')
                  .sort()
                  .reverse()
                  .map(([key, { count, known_exploit_count, percentage }]) => (
                    <Tr key={key}>
                      {/* {JSON.stringify(ChartThemeColor.orange)} */}
                      {key === '8to10' && <Td>8.0 - 10.0</Td>}
                      {key === '4to7.9' && <Td>4.0 - 7.9</Td>}
                      {key === '0to3.9' && <Td>0.0 - 3.9</Td>}
                      <Td>
                        {count}
                        {' ('}
                        {percentage.toFixed(0)}
                        {'% of total)'}
                      </Td>
                      <Td>{known_exploit_count}</Td>
                    </Tr>
                  ))}
              </Tbody>
            </TableComposable>
          </GridItem>
        </Grid>
        <Title
          headingLevel="h3"
        >
          Recently published CVEs indentified on systems
        </Title>
        <Grid>
          <GridItem span={2}>
            <div>Last 7 days</div>
            <div>
              {recent_cves.last7days}
            </div>
          </GridItem>
          <GridItem span={2}>
            <div>Last 30 days</div>
            <div>
              {recent_cves.last30days}
            </div>
          </GridItem>
          <GridItem span={2}>
            <div>Last 90 days</div>
            <div>
              {recent_cves.last90days}
            </div>
          </GridItem>
        </Grid>
        <Title
          headingLevel="h3"
        >
          Top 3 vulnerabilities in your infrastructure
        </Title>
        <TopCves top_cves={top_cves} />
      </Page>
      {/* END OF PAGE 2 */}
      <Page>
        <Title
          headingLevel="h2"
        >
          Insights Security Rules
        </Title>
        <Title
          headingLevel="h3"
        >
          Security rules affecting systems
        </Title>
        <Grid hasGutter>
          <GridItem span={7}>
            <TableComposable variant="compact" borders={false} isStriped>
              <Thead>
                <Tr>
                  <Th modifier="wrap">Severity</Th>
                  <Th modifier="wrap">Num. security rules</Th>
                  <Th modifier="wrap">Num. affected systems</Th>
                </Tr>
              </Thead>
              <Tbody>
                {rulesBySeverity
                  .sort()
                  .reverse()
                  .map(([key, { rule_count, systems_affected }]) => (
                    <Tr key={key}>
                      {key === '4' && <Td>Critical</Td>}
                      {key === '3' && <Td>Important</Td>}
                      {key === '2' && <Td>Moderate</Td>}
                      {key === '1' && <Td>Low</Td>}
                      <Td>{rule_count}</Td>
                      <Td>{systems_affected}</Td>
                    </Tr>
                  ))}
              </Tbody>
            </TableComposable>
          </GridItem>
          <GridItem span={5}>
            <Chart
              domain={{
                y: [0, maxSystemsAffected],
              }}
              domainPadding={{ x: [30, 25] }}
              legendData={[{ name: 'Num. affected systems' }]}
              legendOrientation="vertical"
              legendPosition="bottom"
              height={250}
              padding={{
                bottom: 0,
                left: 60,
                right: 0,
                top: 0,
              }}
              themeColor={ChartThemeColor.orange}
              width={600}
            >
              <ChartBar
                data={[
                  {
                    name: 'Num. affected systems',
                    x: 'Critical',
                    y: rules_by_severity['4'].systems_affected,
                  },
                  {
                    name: 'Num. affected systems',
                    x: 'Important',
                    y: rules_by_severity['3'].systems_affected,
                  },
                  {
                    name: 'Num. affected systems',
                    x: 'Moderate',
                    y: rules_by_severity['2'].systems_affected,
                  },
                  {
                    name: 'Num. affected systems',
                    x: 'Low',
                    y: rules_by_severity['1'].systems_affected,
                  },
                ]}
              />
            </Chart>
          </GridItem>
        </Grid>
        <Title
          headingLevel="h3"
        >
          Top 3 security rules in your infrastructure
        </Title>
        <TopRules top_rules={top_rules} />
      </Page>
    </React.Fragment>
  );
};

export default VulnerabilityExecutiveReportTemplate;
