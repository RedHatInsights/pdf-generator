import { Text, TextContent, Title } from '@patternfly/react-core';
import React from 'react';
import Page from '../../common/page';
import CVETable, { CVETableRow } from '../Components/cve-table';

export type CVEDataItem = {
  id: string;
  attributes: {
    cvss2_score: string;
    cvss3_score: null | string;
    public_date: string;
    impact?: string;
    systems_affected: number;
    business_risk?: string;
    status?: string;
  };
};

const columns = [
  'CVE ID',
  'Publish date',
  'CVSS base score',
  'Severity',
  'Systems',
  'Business risk',
  'Status',
];
const CVETables = ({ data }: { data: CVEDataItem[] }) => {
  const rows: CVETableRow[] = data.map(
    ({
      id,
      attributes: {
        public_date,
        cvss3_score,
        cvss2_score,
        impact,
        systems_affected,
        business_risk,
        status,
      },
    }) => {
      const date = new Date(public_date);
      return [
        <a
          key="link"
          href={`https://console.stage.redhat.com/beta/insights/vulnerability/cves/${id}?page=1&page_size=20&show_advisories=true&sort=-updated`}
        >
          {id}
        </a>,
        date.toLocaleString('us', {
          day: 'numeric',
          month: 'short',
          year: 'numeric',
        }),
        parseFloat(cvss3_score || cvss2_score).toFixed(1),
        impact || 'Unknown',
        systems_affected,
        business_risk || 'Unknown',
        status || 'Unknown',
      ];
    }
  );

  return <CVETable rows={rows} columnsToInclude={columns} />;
};

const CveReport = ({ data }: { data: CVEDataItem[] }) => {
  return (
    <Page>
      <Title
        headingLevel="h1"
        className="pf-u-danger-color-200 pf-u-font-size-4xl pf-u-mb-lg"
      >
        Insights Vulnerability CVE report
      </Title>
      <TextContent>
        <Text>
          This report includes CVEs with a CVSS base score of 0.0 - 10.0;
          published anytime.
        </Text>
        <Text>
          The vulnerability service identified 2,873 CVEs within this criteria
          that impact at least one of your 5656 analyzed RHEL systems. Of the
          identified CVEs, 10 CVEs have a known exploit.
        </Text>
      </TextContent>
      <CVETables data={data} />
    </Page>
  );
};

export default CveReport;
